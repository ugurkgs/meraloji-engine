<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MERALOJƒ∞ | F.I.S.H. System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { 
            --dark: #0f172a; --panel: rgba(15, 23, 42, 0.98); 
            --blue: #38bdf8; --green: #4ade80; --red: #f87171; 
            --yellow: #facc15; --glass-border: 1px solid rgba(255, 255, 255, 0.15); --gray: #94a3b8;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: white; height: 100vh; overflow: hidden; }

        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; cursor: crosshair; background: #0f172a; }
        
        /* RADAR PIN */
        .radar-pin { width: 24px; height: 24px; background: var(--blue); border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px var(--blue); position: relative; }
        .radar-pin::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--blue); animation: pulse 2s infinite; pointer-events: none; opacity: 0.5; }
        @keyframes pulse { 0% { width: 0; height: 0; opacity: 0.8; } 100% { width: 100px; height: 100px; opacity: 0; } }

        .bait-icon { font-size: 24px; text-align: center; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--dark); background-image: radial-gradient(circle at center, #1e293b 0%, #020617 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s ease-in-out; padding: 20px; text-align: center; }
        .splash-title-top { font-size: 2.8em; font-weight: 900; color: white; letter-spacing: 4px; margin-bottom: 20px; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .splash-logo { width: 240px; height: 240px; filter: drop-shadow(0 0 40px rgba(56, 189, 248, 0.5)); margin-bottom: 20px; animation: float 3s ease-in-out infinite;}
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .splash-fish { font-family: 'Share Tech Mono', monospace; font-size: 2.5em; color: var(--blue); letter-spacing: 8px; font-weight: bold; margin-top: 10px; text-shadow: 0 0 20px var(--blue); }
        .splash-sub { font-family: 'Montserrat', sans-serif; font-size: 0.9em; letter-spacing: 4px; color: var(--gray); margin-top: 5px; font-weight: 600; }

        #controls-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 94%; max-width: 480px; z-index: 2000; display: flex; gap: 12px; align-items: center; pointer-events: none; opacity: 0; transition: opacity 1s ease 0.5s; }
        #controls-bar.visible { opacity: 1; }
        #controls-bar > * { pointer-events: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.4); backdrop-filter: blur(10px); }
        .control-group { background: var(--panel); border: var(--glass-border); border-radius: 14px; display: flex; align-items: center; padding: 5px 15px; flex: 1; height: 50px; }
        .btn-glass { background: var(--panel); border: var(--glass-border); color: white; width: 50px; height: 50px; border-radius: 14px; font-size: 1.4em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .search-input { background: transparent; border: none; color: white; padding: 0 10px; width: 100%; font-family: 'Montserrat', sans-serif; font-size: 1em; font-weight: 500; }
        #suggestions { position: absolute; top: 65px; left: 62px; right: 62px; background: var(--panel); border: var(--glass-border); border-radius: 12px; max-height: 200px; overflow-y: auto; display: none; flex-direction: column; z-index: 3000; pointer-events: auto; backdrop-filter: blur(10px); }
        .suggestion-item { padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 0.95em; }

        #side-menu { position: absolute; top: 0; left: 0; width: 280px; height: 100%; background: rgba(10, 14, 23, 0.98); z-index: 4000; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 25px; border-right: var(--glass-border); pointer-events: auto; display: flex; flex-direction: column; justify-content: space-between; }
        #side-menu.active { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
        .menu-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3999; display:none; backdrop-filter: blur(3px); }
        .menu-header { color: var(--blue); font-weight: 900; letter-spacing: 2px; margin-bottom: 25px; font-size: 1.5em; text-transform: uppercase; }
        .secondary-btn { width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: var(--glass-border); color: white; font-weight: 600; border-radius: 12px; cursor: pointer; margin-top: 12px; font-size: 0.9em; transition: background 0.2s; text-align: left; padding-left: 15px; }

        #hud-panel { position: absolute; bottom: 0; left: 0; width: 100%; max-height: 90vh; background: var(--panel); border-radius: 24px 24px 0 0; z-index: 2000; display: none; flex-direction: column; box-shadow: 0 -10px 50px rgba(0,0,0,0.6); border-top: var(--glass-border); pointer-events: auto; backdrop-filter: blur(15px); }
        @media(min-width: 768px) { #hud-panel { bottom: 20px; right: 20px; left: auto; width: 450px; border-radius: 16px; max-height: 90vh; border: var(--glass-border); } }
        .panel-header { padding: 18px 24px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; }
        .panel-content { padding: 20px 24px; overflow-y: auto; -webkit-overflow-scrolling: touch; scroll-behavior: auto; }
        
        .score-box { text-align: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); border-radius: 16px; border: var(--glass-border); position: relative;}
        .main-score { font-size: 4em; font-weight: 900; line-height: 1; color: var(--green); text-shadow: 0 0 30px rgba(74, 222, 128, 0.4); margin: 5px 0; }
        .weather-summary { font-family: 'Share Tech Mono'; color: var(--blue); font-size: 1.1em; letter-spacing: 1px; margin-top: 5px; font-weight: 700; text-transform: uppercase; }
        
        /* NEW: MODE SWITCHER */
        .mode-switch { display: flex; justify-content: center; margin-bottom: 15px; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 4px; display: inline-flex; }
        .mode-btn { background: transparent; border: none; color: #888; padding: 6px 16px; border-radius: 16px; font-weight: 700; font-size: 0.8em; cursor: pointer; transition: all 0.2s; }
        .mode-btn.active { background: var(--blue); color: #000; box-shadow: 0 0 10px rgba(56, 189, 248, 0.4); }

        .metric-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px; }
        @media(min-width: 480px) { .metric-grid { grid-template-columns: repeat(5, 1fr); } }
        
        .metric-card { background: rgba(255,255,255,0.04); padding: 8px 4px; border-radius: 10px; text-align: center; display:flex; flex-direction:column; justify-content:center; min-height:70px; border: 1px solid rgba(255,255,255,0.05); cursor: help; transition: background 0.2s; position: relative;}
        .metric-card:active { background: rgba(255,255,255,0.1); }
        .m-val { font-weight: 800; color: white; font-size: 0.9em; white-space:nowrap; }
        .m-lbl { font-size: 0.55em; color: var(--gray); margin-top: 2px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;}
        .m-status { font-size: 0.5em; font-weight: 900; margin-top: 2px; letter-spacing: 0.5px; padding: 1px 4px; border-radius: 4px; display: inline-block; }
        .status-good { color: var(--green); background: rgba(74, 222, 128, 0.1); }
        .status-warn { color: var(--yellow); background: rgba(250, 204, 21, 0.1); }
        .status-bad { color: var(--red); background: rgba(248, 113, 113, 0.1); }
        .status-neutral { color: var(--blue); background: rgba(56, 189, 248, 0.1); }
        
        .action-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--blue), #2563eb); border: none; color: white; font-weight: 800; border-radius: 12px; cursor: pointer; margin-top: 10px; box-shadow: 0 5px 20px rgba(37, 99, 235, 0.4); font-size: 1em; letter-spacing: 1px; }
        
        .fish-item { padding: 14px; background: linear-gradient(90deg, rgba(255,255,255,0.04) 0%, transparent 100%); border-radius: 12px; border-left: 4px solid #555; margin-bottom: 8px; cursor:pointer; position: relative; overflow: hidden; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .fish-details { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 0.85em; color: #cbd5e1; line-height: 1.6; }
        .fish-item.open .fish-details { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 5000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; pointer-events: auto; }
        .day-row { display: flex; justify-content: space-between; align-items: center; padding: 18px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background 0.2s; }
        .day-row:active { background: rgba(255,255,255,0.1); }
        .day-score-badge { font-weight: 900; padding: 5px 10px; border-radius: 5px; background: rgba(255,255,255,0.1); }

        .tech-content { color: #cbd5e1; line-height: 1.7; font-size: 0.9em; }
        .tech-item { margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border-left: 3px solid var(--blue); }
        
        .calc-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.98); z-index: 2500; display: none; align-items: center; justify-content: center; flex-direction: column; font-family: 'Share Tech Mono', monospace; pointer-events: auto; padding: 20px; text-align: left; }
        .radar-spinner { width: 60px; height: 60px; border-radius: 50%; border: 2px solid rgba(56, 189, 248, 0.1); border-top-color: var(--blue); animation: radar 1s linear infinite; margin-bottom: 20px; }
        #log-container { width: 100%; max-width: 350px; font-size: 0.9em; color: #cbd5e1; line-height: 1.6; }
        .log-line { margin-bottom: 5px; opacity: 0; animation: fadeIn 0.1s forwards; }
        .log-val { color: var(--yellow); font-weight: bold; margin-left: 10px; }
        @keyframes radar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { to { opacity: 1; } }

        .metric-info-row { margin-bottom: 15px; text-align: left; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; }
        .metric-label { color: var(--blue); font-size: 0.8em; font-weight: bold; margin-bottom: 4px; letter-spacing: 1px; }
        .metric-val { color: white; font-size: 0.95em; line-height: 1.4; }
        
        #error-banner { position:fixed; top:0; left:0; width:100%; background:red; color:white; padding:10px; font-size:0.8em; z-index:10000; display:none; text-align:center;}
    </style>
</head>
<body>
    <div id="error-banner"></div>
    
    <div id="splash-screen">
        <div class="splash-title-top">MERALOJƒ∞</div>
        <img src="logo.png" alt="Meraloji" class="splash-logo" onerror="this.style.display='none'">
        <div class="splash-fish">F.I.S.H.</div>
        <div class="splash-sub">FIND INSPECT SEE HUNT</div>
    </div>
    
    <div id="controls-bar">
        <button class="btn-glass" onclick="toggleMenu()">‚ò∞</button>
        <div class="control-group">
            <span style="font-size:1.2em; color:var(--gray); margin-right:10px;">üîç</span>
            <input type="text" id="search-input" class="search-input" placeholder="Mera ara...">
        </div>
        <button class="btn-glass" style="color:var(--blue)" onclick="locateMe()">üéØ</button>
    </div>
    <div id="suggestions"></div>
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
    
    <div id="side-menu">
        <div>
            <div class="menu-header">MERALOJƒ∞</div>
            <div class="menu-section">
                <h3>Favori Meralarƒ±m</h3>
                <div id="fav-list"></div>
            </div>
            <div class="menu-section">
                <h3>Men√º</h3>
                <button class="secondary-btn" onclick="changeMapLayer()">üó∫Ô∏è Harita Katmanƒ±</button>
                <button class="secondary-btn" onclick="openTechModal()">üß† Algoritma Detayƒ±</button>
            </div>
        </div>
        <div style="text-align:center; color:#666; font-size:0.8em; margin-top:20px;">Geli≈ütirici: Uƒüur K√∂g√ºs<br>v48.0 Instant</div>
    </div>
    
    <div id="map"></div>
    
    <div class="calc-overlay" id="loading">
        <div class="radar-spinner"></div>
        <div id="log-container"></div>
    </div>
    
    <div id="hud-panel">
        <div class="panel-header">
            <span style="font-weight:800; color:white; font-size:1.2em;" id="region-title">--</span>
            <button class="btn-glass" style="width:36px; height:36px; background:transparent; border:none;" onclick="closePanel()">‚úï</button>
        </div>
        <div class="panel-content">
            
            <div class="score-box">
                <div class="mode-switch">
                    <button class="mode-btn active" id="btn-daily" onclick="setMode('daily')">G√úNL√úK</button>
                    <button class="mode-btn" id="btn-instant" onclick="setMode('instant')">ANLIK (≈ûU AN)</button>
                </div>
                <div class="main-score" id="score-val">--</div>
                <div class="weather-summary" id="weather-val">--</div>
                <div style="font-size:0.7em; color:#cbd5e1; background:rgba(0,0,0,0.3); padding:4px 12px; border-radius:20px; display:inline-block; margin-top:10px;" id="conf-val">G√ºven: %</div>
            </div>

            <div style="background:rgba(59,130,246,0.1); border-left:3px solid var(--blue); padding:15px; border-radius:8px; font-size:0.9em; margin-bottom:20px; color:#e2e8f0; line-height:1.5;">
                <span style="font-size:1.5em; vertical-align:middle; margin-right:10px;">üí°</span><span id="tactic-text">...</span>
            </div>
            
            <div class="metric-grid" id="main-grid"></div>

            <div style="font-size:0.85em; color:var(--gray); margin-bottom:10px; font-weight:800; margin-top:20px;">T√ºrler (Detay ƒ∞√ßin Tƒ±klayƒ±n)</div>
            <div id="fish-list"></div>
            
            <button class="action-btn" onclick="showWeeklyModal()">üìÖ 7 G√ºnl√ºk Tahmin Raporu</button>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button class="secondary-btn" style="text-align:center; margin-top:0;" onclick="findBaitShops()">ü™± Yemcileri Bul</button>
                <button class="secondary-btn" style="text-align:center; margin-top:0;" onclick="saveFavorite()">‚≠ê Kaydet</button>
            </div>

        </div>
    </div>

    <div id="weekly-modal" class="modal-overlay">
        <button class="secondary-btn" style="width:auto; margin-bottom:20px; background:rgba(255,255,255,0.05); text-align:center;" onclick="document.getElementById('weekly-modal').style.display='none'">‚Üê GERƒ∞ D√ñN</button>
        <h2 style="text-align:center; color:var(--blue); font-weight:900;">7 G√úNL√úK TAHMƒ∞N</h2>
        <div id="weekly-content"></div>
    </div>

    <div id="day-detail-modal" class="modal-overlay">
        <button class="secondary-btn" style="width:auto; margin-bottom:20px; background:rgba(255,255,255,0.05); text-align:center;" onclick="document.getElementById('day-detail-modal').style.display='none'">‚Üê Lƒ∞STEYE D√ñN</button>
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:1.5em; font-weight:900;" id="dd-date">--</div>
            <div style="font-size:3em; font-weight:900; margin:10px 0;" id="dd-score">--</div>
            <div style="color:var(--blue); font-family:'Share Tech Mono'; font-weight:bold;" id="dd-weather">--</div>
        </div>
        <div style="background:rgba(59,130,246,0.1); border-left:3px solid var(--blue); padding:15px; border-radius:8px; font-size:0.9em; margin-bottom:20px;">
            <div id="dd-tactic">--</div>
        </div>
        <div id="dd-fish-list"></div>
    </div>
    
    <div id="tech-modal" class="modal-overlay">
        <button class="secondary-btn" style="width:auto; margin-bottom:20px; background:rgba(255,255,255,0.05); text-align:center;" onclick="document.getElementById('tech-modal').style.display='none'">KAPAT</button>
        <h2 style="text-align:center; color:var(--blue); font-weight:900; letter-spacing:1px; margin-bottom:30px;">F.I.S.H. ALGORƒ∞TMASI</h2>
        <div class="tech-content">
            <div class="tech-item"><span class="tech-title">1. BULANIK MANTIK</span>Sistem, atmosferik verileri Bulanƒ±k Mantƒ±k ile i≈üler.</div>
        </div>
    </div>
    
    <div id="metric-modal" class="modal-overlay" style="justify-content:center; background:rgba(0,0,0,0.85);">
        <div style="background:var(--panel); border:1px solid var(--blue); padding:25px; border-radius:16px; width:90%; max-width:400px; text-align:center; position:relative;">
            <div id="metric-icon" style="font-size:3em; margin-bottom:10px;">üå°Ô∏è</div>
            <h3 id="metric-title" style="color:var(--blue); margin-top:0; margin-bottom:20px;">SU ISISI</h3>
            <div class="metric-info-row"><div class="metric-label">NEDƒ∞R?</div><div class="metric-val" id="metric-desc">...</div></div>
            <div class="metric-info-row"><div class="metric-label">REFERANS ARALIƒûI</div><div class="metric-val" id="metric-ref">...</div></div>
            <div class="metric-info-row"><div class="metric-label">ALGORƒ∞TMA ETKƒ∞Sƒ∞</div><div class="metric-val" id="metric-algo" style="color:#a78bfa;">...</div></div>
            <button class="action-btn" style="margin-top:10px; padding:12px;" onclick="document.getElementById('metric-modal').style.display='none'">KAPAT</button>
        </div>
    </div>

    <script>
        // HATA Y√ñNETƒ∞Mƒ∞
        window.onerror = function(msg, url, line) {
            const errBanner = document.getElementById('error-banner');
            errBanner.style.display = 'block';
            errBanner.innerText = `HATA: ${msg}`;
            setTimeout(forceCloseSplash, 1000);
        };
        function forceCloseSplash() {
            const splash = document.getElementById('splash-screen');
            if(splash.style.display !== 'none') {
                splash.style.opacity = '0';
                document.getElementById('controls-bar').classList.add('visible');
                setTimeout(() => { splash.style.display = 'none'; }, 800);
            }
        }
        setTimeout(forceCloseSplash, 3000);

        // DATA CACHE
        let GLOBAL_DATA = null;
        let CURRENT_MODE = 'daily'; // 'daily' or 'instant'

        const METRIC_DATA = {
            "temp": { icon: "üå°Ô∏è", title: "SU ISISI", desc: "Balƒ±k metabolizmasƒ±nƒ± belirler.", ref: "Ege: 18-24¬∞C | Marmara: 14-19¬∞C", algo: "Gaussian eƒürisi ile hesaplanƒ±r." },
            "clarity": { icon: "üëÅÔ∏è", title: "SU G√ñR√ú≈û√ú", desc: "Avcƒ± balƒ±ƒüƒ±n yemi g√∂rmesini saƒülar.", ref: "ƒ∞deal: %50-%85", algo: "Berrak suda ipucu cezasƒ± verilir." },
            "wind": { icon: "üí®", title: "R√úZGAR", desc: "Plankton ta≈üƒ±r ve suyu oksijenlendirir.", ref: "0-25 km/s g√ºvenli.", algo: "Marmara'da Lodos +15 puan." },
            "wave": { icon: "üåä", title: "DALGA", desc: "Levrek i√ßin kamuflaj saƒülar.", ref: "0.5m √ºst√º Levrek havasƒ±dƒ±r.", algo: "Y√ºksek dalga = Levrek Bonusu." },
            "salinity": { icon: "üßÇ", title: "TUZLULUK", desc: "Kaldƒ±rma kuvvetini etkiler.", ref: "Ege ~38, Marmara ~22 PSU", algo: "Yaƒümur sonrasƒ± d√º≈üer." },
            "pressure": { icon: "üìâ", title: "BASIN√á", desc: "Hava kesesini etkiler.", ref: "D√º≈üen basƒ±n√ß = Aktif balƒ±k.", algo: "D√º≈ü√º≈ü trendi bonus verir." },
            "moon": { icon: "üåë", title: "AY FAZI", desc: "Gelgiti tetikler.", ref: "Dolunay ve Yeni Ay iyidir.", algo: "Solunar katsayƒ±sƒ±nƒ± belirler." },
            "tide": { icon: "üåä", title: "GELGƒ∞T", desc: "Su hareketliliƒüidir.", ref: "Hareketli su iyidir.", algo: "Slack tide cezasƒ± vardƒ±r." },
            "current": { icon: "üîÑ", title: "AKINTI", desc: "Boƒüaz'da hayat kaynaƒüƒ±dƒ±r.", ref: "0.6m/s √ºst√º surf gerektirir.", algo: "Pelajik balƒ±klar i√ßin bonus." },
            "cloud": { icon: "‚òÅÔ∏è", title: "BULUT", desc: "I≈üƒ±ƒüƒ± kƒ±rar, balƒ±k cesurla≈üƒ±r.", ref: "Kapalƒ± hava avcƒ± i√ßin iyidir.", algo: "Su √ºst√º sahte bonusu." }
        };

        // MAP SETUP
        let map;
        try {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([38.4237, 27.1428], 10);
            const layers = { 
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 }), 
                street: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }) 
            };
            let currentLayer = 'street'; layers.street.addTo(map); 
            
            let markerLayer = null; let lastLatLon = null; let baitMarkers = [];

            map.on('click', async (e) => {
                const lat = e.latlng.lat.toFixed(4); const lon = e.latlng.lng.toFixed(4); lastLatLon = { lat, lon };
                if(markerLayer) map.removeLayer(markerLayer);
                baitMarkers.forEach(m => map.removeLayer(m)); baitMarkers = [];

                markerLayer = L.marker([lat, lon], { icon: L.divIcon({ className: 'radar-pin', iconSize: [24, 24], iconAnchor: [12, 12] }) }).addTo(map);
                
                document.getElementById('hud-panel').style.display = 'none';
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('log-container').innerHTML = ''; 
                
                try {
                    const res = await fetch(`/api/forecast?lat=${lat}&lon=${lon}`); const data = await res.json();
                    GLOBAL_DATA = data; // Cache data
                    runMatrixAnimation(data);
                } catch(err) { 
                    document.getElementById('loading').style.display = 'none';
                    alert("Baƒülantƒ± hatasƒ±."); 
                }
            });
        } catch(e) { console.error("Map Error", e); }

        window.addEventListener('load', () => { loadFavorites(); });

        function getColor(s) { return s >= 80 ? 'var(--green)' : (s >= 50 ? 'var(--yellow)' : 'var(--red)'); }

        function runMatrixAnimation(data) {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = ''; 
            const steps = [
                { text: `üì° BAƒûLANTI: ${data.region}`, delay: 0 },
                { text: `‚è±Ô∏è SAAT: ${data.clickHour}:00`, delay: 300 },
                { text: `üåä VERƒ∞LER ƒ∞≈ûLENƒ∞YOR...`, delay: 800 },
                { text: `üé£ HESAPLAMA TAMAMLANDI.`, delay: 1500 }
            ];

            steps.forEach(step => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = 'log-line'; div.innerHTML = `> ${step.text}`;
                    logContainer.appendChild(div);
                }, step.delay);
            });

            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                // Varsayƒ±lan olarak G√úNL√úK modda a√ß
                setMode('daily'); 
                document.getElementById('hud-panel').style.display = 'flex';
            }, 1800);
        }

        // --- CORE LOGIC: MODE SWITCHER ---
        function setMode(mode) {
            if (!GLOBAL_DATA) return;
            CURRENT_MODE = mode;

            // Buton stillerini g√ºncelle
            document.getElementById('btn-daily').className = mode === 'daily' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btn-instant').className = mode === 'instant' ? 'mode-btn active' : 'mode-btn';

            let targetData;

            if (mode === 'daily') {
                targetData = GLOBAL_DATA.forecast[0]; // G√ºnl√ºk √∂zet
            } else {
                targetData = GLOBAL_DATA.instant; // Anlƒ±k veri
            }

            renderPanel(GLOBAL_DATA, targetData);
        }

        function renderPanel(global, data) {
            document.getElementById('region-title').innerText = global.region;
            
            if (global.isLand) {
                // Kara durumu...
                document.getElementById('score-val').innerText = "KARA";
                return;
            }

            // Skor ve Hava
            document.getElementById('score-val').innerHTML = '<span style="font-size:0.4em; vertical-align:super; opacity:0.8;">%</span>' + data.score.toFixed(1);
            document.getElementById('score-val').style.color = getColor(data.score);
            document.getElementById('weather-val').innerText = data.weatherSummary || "";
            document.getElementById('tactic-text').innerText = data.tactic;

            // Metrikler (Daily/Instant deƒüi≈üimine g√∂re g√ºncellenebilir ama ≈üimdilik g√ºnl√ºkten alƒ±yoruz g√∂rsel tutarlƒ±lƒ±k i√ßin)
            // ƒ∞sterseniz Instant objesine de t√ºm metrikleri koyup burayƒ± dinamik yapabiliriz.
            // ≈ûimdilik ana metrikleri g√ºncelleyelim.
            const dailyRef = global.forecast[0];
            const displayTemp = (CURRENT_MODE === 'instant') ? data.temp : dailyRef.temp;
            const displayWind = (CURRENT_MODE === 'instant') ? data.wind : dailyRef.wind;

            const grid = document.getElementById('main-grid');
            grid.innerHTML = 
                createMetricCard('temp', displayTemp, '¬∞') +
                createMetricCard('wind', displayWind, ' km') +
                createMetricCard('clarity', dailyRef.clarity, '%') +
                createMetricCard('wave', dailyRef.wave, 'm') +
                createMetricCard('salinity', dailyRef.salinity, ' P') +
                createMetricCard('pressure', (CURRENT_MODE==='instant'?data.pressure:dailyRef.pressure), ' hP') +
                createMetricCard('moon', null, '') + 
                createMetricCard('tide', dailyRef.tide, 'm') +
                createMetricCard('current', dailyRef.current, '') +
                createMetricCard('cloud', dailyRef.cloud, '%');

            // Balƒ±k Listesi
            renderFishList(data.fishList, 'fish-list');
        }

        function createMetricCard(key, rawVal, unit) {
            if (rawVal === undefined || rawVal === null) rawVal = '--';
            const valStr = (typeof rawVal === 'number') ? rawVal.toFixed(0) : rawVal;
            return `<div class="metric-card" onclick="openMetricInfo('${key}')"><div class="m-val">${valStr}${unit}</div><div class="m-lbl">${METRIC_DATA[key].title}</div></div>`;
        }

        function renderFishList(list, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            list.forEach(f => {
                const c = getColor(f.score);
                const reason = f.reason ? `<div style="font-size:0.8em; color:${f.score > 50 ? 'var(--green)' : 'var(--red)'}; margin-bottom:5px; font-weight:bold;">${f.score > 50 ? '‚úÖ' : '‚ö†Ô∏è'} ${f.reason}</div>` : '';
                container.innerHTML += `
                    <div class="fish-item" style="border-left-color:${c}" onclick="this.classList.toggle('open')">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:bold;">${f.icon} ${f.name}</div>
                            <div style="font-weight:900; color:${c}">%${f.score.toFixed(1)}</div>
                        </div>
                        <div class="fish-details">
                            ${reason}
                            <div>üéØ <b>Yem:</b> ${f.bait}</div>
                            <div>üé£ <b>ƒ∞ƒüne:</b> ${f.method}</div>
                            <div style="margin-top:5px; color:#e2e8f0; font-style:italic; font-size:0.9em;">üí° ${f.note}</div>
                        </div>
                    </div>`;
            });
        }
        
        // Modal functions...
        function openMetricInfo(key) {
            const d = METRIC_DATA[key]; if(!d) return;
            document.getElementById('metric-title').innerText = d.title;
            document.getElementById('metric-desc').innerText = d.desc;
            document.getElementById('metric-ref').innerText = d.ref;
            document.getElementById('metric-algo').innerText = d.algo;
            document.getElementById('metric-modal').style.display = 'flex';
        }
        function closePanel() { document.getElementById('hud-panel').style.display = 'none'; }
        function toggleMenu() { document.getElementById('side-menu').classList.toggle('active'); document.getElementById('menu-overlay').style.display = document.getElementById('side-menu').classList.contains('active') ? 'block' : 'none'; }
        function changeMapLayer() { toggleMenu(); alert("Katman deƒüi≈ütirildi."); }
        function openTechModal() { toggleMenu(); document.getElementById('tech-modal').style.display = 'flex'; }
        function saveFavorite() { if(!lastLatLon) return; const n = prompt("Ad:"); if(n){ alert("Kaydedildi."); } }
        function loadFavorites() { document.getElementById('fav-list').innerHTML = "Kayƒ±t yok."; }
        async function findBaitShops() { alert("Yemciler aranƒ±yor..."); }
        function showWeeklyModal() { document.getElementById('weekly-modal').style.display = 'flex'; }
        function locateMe() { navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 14)); }

    </script>
</body>
</html>
