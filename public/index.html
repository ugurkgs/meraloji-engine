<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MERALOJÄ° | F.I.S.H. System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { 
            --dark: #0f172a; 
            --panel: rgba(15, 23, 42, 0.98); 
            --blue: #38bdf8; 
            --green: #4ade80; 
            --red: #f87171; 
            --yellow: #facc15; 
            --orange: #fb923c;
            --glass-border: 1px solid rgba(255, 255, 255, 0.15);
            --gray: #94a3b8;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: white; height: 100vh; overflow: hidden; }

        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; cursor: crosshair; }
        .radar-pin { width: 24px; height: 24px; background: var(--blue); border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px var(--blue); position: relative; }
        .radar-pin::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--blue); animation: pulse 2s infinite; pointer-events: none; opacity: 0.5; }
        @keyframes pulse { 0% { width: 0; height: 0; opacity: 0.8; } 100% { width: 100px; height: 100px; opacity: 0; } }

        /* YEMCÄ° Ä°KONU */
        .bait-icon { font-size: 24px; text-align: center; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        /* UI ELEMENTS */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--dark); background-image: radial-gradient(circle at center, #1e293b 0%, #020617 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.8s ease-in-out; padding: 20px; text-align: center; }
        .splash-title-top { font-size: 2.8em; font-weight: 900; color: white; letter-spacing: 4px; margin-bottom: 20px; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .splash-logo { width: 240px; height: 240px; filter: drop-shadow(0 0 40px rgba(56, 189, 248, 0.5)); margin-bottom: 20px; animation: float 3s ease-in-out infinite;}
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .splash-fish { font-family: 'Share Tech Mono', monospace; font-size: 2.5em; color: var(--blue); letter-spacing: 8px; font-weight: bold; margin-top: 10px; text-shadow: 0 0 20px var(--blue); }
        .splash-sub { font-family: 'Montserrat', sans-serif; font-size: 0.9em; letter-spacing: 4px; color: var(--gray); margin-top: 5px; font-weight: 600; }

        #controls-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 94%; max-width: 480px; z-index: 2000; display: flex; gap: 12px; align-items: center; pointer-events: none; opacity: 0; transition: opacity 1s ease 0.5s; }
        #controls-bar.visible { opacity: 1; }
        #controls-bar > * { pointer-events: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.4); backdrop-filter: blur(10px); }
        .control-group { background: var(--panel); border: var(--glass-border); border-radius: 14px; display: flex; align-items: center; padding: 5px 15px; flex: 1; height: 50px; }
        .btn-glass { background: var(--panel); border: var(--glass-border); color: white; width: 50px; height: 50px; border-radius: 14px; font-size: 1.4em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .search-input { background: transparent; border: none; color: white; padding: 0 10px; width: 100%; font-family: 'Montserrat', sans-serif; font-size: 1em; font-weight: 500; }
        #suggestions { position: absolute; top: 65px; left: 62px; right: 62px; background: var(--panel); border: var(--glass-border); border-radius: 12px; max-height: 200px; overflow-y: auto; display: none; flex-direction: column; z-index: 3000; pointer-events: auto; backdrop-filter: blur(10px); }
        .suggestion-item { padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 0.95em; }

        #side-menu { position: absolute; top: 0; left: 0; width: 280px; height: 100%; background: rgba(10, 14, 23, 0.98); z-index: 4000; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 25px; border-right: var(--glass-border); pointer-events: auto; display: flex; flex-direction: column; justify-content: space-between; }
        #side-menu.active { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
        .menu-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3999; display:none; backdrop-filter: blur(3px); }
        .menu-header { color: var(--blue); font-weight: 900; letter-spacing: 2px; margin-bottom: 25px; font-size: 1.5em; text-transform: uppercase; }
        .secondary-btn { width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: var(--glass-border); color: white; font-weight: 600; border-radius: 12px; cursor: pointer; margin-top: 12px; font-size: 0.9em; transition: background 0.2s; text-align: left; padding-left: 15px; }

        #hud-panel { position: absolute; bottom: 0; left: 0; width: 100%; max-height: 90vh; background: var(--panel); border-radius: 24px 24px 0 0; z-index: 2000; display: none; flex-direction: column; box-shadow: 0 -10px 50px rgba(0,0,0,0.6); border-top: var(--glass-border); pointer-events: auto; backdrop-filter: blur(15px); }
        @media(min-width: 768px) { #hud-panel { bottom: 20px; right: 20px; left: auto; width: 450px; border-radius: 16px; max-height: 90vh; border: var(--glass-border); } }
        .panel-header { padding: 18px 24px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; }
        .panel-content { padding: 20px 24px; overflow-y: auto; -webkit-overflow-scrolling: touch; scroll-behavior: auto; }
        
        .score-box { text-align: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); border-radius: 16px; border: var(--glass-border); }
        .main-score { font-size: 4em; font-weight: 900; line-height: 1; color: var(--green); text-shadow: 0 0 30px rgba(74, 222, 128, 0.4); margin: 5px 0; }
        .weather-summary { font-family: 'Share Tech Mono'; color: var(--blue); font-size: 1.1em; letter-spacing: 1px; margin-top: 5px; font-weight: 700; text-transform: uppercase; }

        .metric-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px; }
        @media(min-width: 480px) { .metric-grid { grid-template-columns: repeat(5, 1fr); } }
        
        .metric-card { background: rgba(255,255,255,0.04); padding: 8px 4px; border-radius: 10px; text-align: center; display:flex; flex-direction:column; justify-content:center; min-height:70px; border: 1px solid rgba(255,255,255,0.05); cursor: help; transition: background 0.2s; position: relative;}
        .metric-card:active { background: rgba(255,255,255,0.1); }
        .metric-card::after { content:'?'; position:absolute; top:2px; right:4px; font-size:0.6em; color:#555; }
        .m-val { font-weight: 800; color: white; font-size: 0.9em; white-space:nowrap; }
        .m-lbl { font-size: 0.55em; color: var(--gray); margin-top: 2px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;}
        .m-status { font-size: 0.5em; font-weight: 900; margin-top: 2px; letter-spacing: 0.5px; padding: 1px 4px; border-radius: 4px; display: inline-block; }
        .status-good { color: var(--green); background: rgba(74, 222, 128, 0.1); }
        .status-warn { color: var(--yellow); background: rgba(250, 204, 21, 0.1); }
        .status-bad { color: var(--red); background: rgba(248, 113, 113, 0.1); }
        .status-neutral { color: var(--blue); background: rgba(56, 189, 248, 0.1); }
        
        .action-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--blue), #2563eb); border: none; color: white; font-weight: 800; border-radius: 12px; cursor: pointer; margin-top: 10px; box-shadow: 0 5px 20px rgba(37, 99, 235, 0.4); font-size: 1em; letter-spacing: 1px; }
        
        .fish-item { padding: 14px; background: linear-gradient(90deg, rgba(255,255,255,0.04) 0%, transparent 100%); border-radius: 12px; border-left: 4px solid #555; margin-bottom: 8px; cursor:pointer; position: relative; overflow: hidden; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .fish-details { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 0.85em; color: #cbd5e1; line-height: 1.6; }
        .fish-item.open .fish-details { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 5000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; pointer-events: auto; }
        .day-row { display: flex; justify-content: space-between; align-items: center; padding: 18px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background 0.2s; }
        .day-row:active { background: rgba(255,255,255,0.1); }
        .day-score-badge { font-weight: 900; padding: 5px 10px; border-radius: 5px; background: rgba(255,255,255,0.1); }

        /* TECH & INFO MODAL */
        .tech-content { color: #cbd5e1; line-height: 1.7; font-size: 0.9em; }
        .tech-item { margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border-left: 3px solid var(--blue); }
        .tech-title { font-weight: 700; color: white; font-size: 1.1em; margin-bottom: 5px; display: block; }
        
        .loading-active { display: flex !important; }
        .calc-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(5px); z-index: 2500; display: none; align-items: center; justify-content: center; flex-direction: column; font-family: 'Share Tech Mono', monospace; pointer-events: auto; }
        .radar-spinner { width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(56, 189, 248, 0.1); border-top-color: var(--blue); animation: radar 1s linear infinite; margin-bottom: 30px; box-shadow: 0 0 40px rgba(56, 189, 248, 0.2); }
        @keyframes radar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* METRIC MODAL STYLES (NEW) */
        .metric-info-row { margin-bottom: 15px; text-align: left; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; }
        .metric-label { color: var(--blue); font-size: 0.8em; font-weight: bold; margin-bottom: 4px; letter-spacing: 1px; }
        .metric-val { color: white; font-size: 0.95em; line-height: 1.4; }
        .ref-green { color: var(--green); font-weight: bold; }
        .ref-red { color: var(--red); font-weight: bold; }
    </style>
</head>
<body>
    <div id="splash-screen">
        <div class="splash-title-top">MERALOJÄ°</div>
        <img src="logo.png" alt="Meraloji" class="splash-logo" onerror="this.style.display='none'">
        <div class="splash-fish">F.I.S.H.</div>
        <div class="splash-sub">FIND INSPECT SEE HUNT</div>
    </div>
    
    <div id="controls-bar">
        <button class="btn-glass" onclick="toggleMenu()">â˜°</button>
        <div class="control-group">
            <span style="font-size:1.2em; color:var(--gray); margin-right:10px;">ğŸ”</span>
            <input type="text" id="search-input" class="search-input" placeholder="Mera ara...">
        </div>
        <button class="btn-glass" style="color:var(--blue)" onclick="locateMe()">ğŸ¯</button>
    </div>
    <div id="suggestions"></div>
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
    
    <div id="side-menu">
        <div>
            <div class="menu-header">MERALOJÄ°</div>
            <div class="menu-section">
                <h3>FAVORÄ° MERALAR</h3>
                <div id="fav-list"></div>
            </div>
            <div class="menu-section">
                <h3>SÄ°STEM</h3>
                <button class="secondary-btn" onclick="changeMapLayer()">ğŸ—ºï¸ Harita KatmanÄ±</button>
                <button class="secondary-btn" onclick="openTechModal()">ğŸ§  Algoritma DetayÄ±</button>
            </div>
        </div>
        <div style="text-align:center; color:#666; font-size:0.8em; margin-top:20px;">GeliÅŸtirici: UÄŸur KÃ¶gÃ¼s<br>v2.0 Master</div>
    </div>
    
    <div id="map"></div>
    
    <div class="calc-overlay" id="loading">
        <div class="radar-spinner"></div>
        <div style="color:var(--blue); font-family:'Share Tech Mono';">ANALÄ°Z YAPILIYOR...</div>
    </div>
    
    <div id="hud-panel">
        <div class="panel-header">
            <span style="font-weight:800; color:white; font-size:1.2em;" id="region-title">--</span>
            <button class="btn-glass" style="width:36px; height:36px; background:transparent; border:none;" onclick="closePanel()">âœ•</button>
        </div>
        <div class="panel-content">
            <div class="score-box">
                <div class="main-score" id="score-val">--</div>
                <div class="weather-summary" id="weather-val">--</div>
                <div style="font-size:0.7em; color:#cbd5e1; background:rgba(0,0,0,0.3); padding:4px 12px; border-radius:20px; display:inline-block; margin-top:10px;" id="conf-val">DOÄRULUK: --</div>
            </div>

            <div style="background:rgba(59,130,246,0.1); border-left:3px solid var(--blue); padding:15px; border-radius:8px; font-size:0.9em; margin-bottom:20px; color:#e2e8f0; line-height:1.5;">
                <span style="font-size:1.5em; vertical-align:middle; margin-right:10px;">ğŸ’¡</span><span id="tactic-text">...</span>
            </div>
            
            <div class="metric-grid" id="main-grid"></div>

            <div style="font-size:0.85em; color:var(--gray); margin-bottom:10px; font-weight:800; margin-top:20px;">TÃœRLER (DETAY Ä°Ã‡Ä°N TIKLA)</div>
            <div id="fish-list"></div>
            
            <button class="action-btn" onclick="showWeeklyModal()">ğŸ“… 7 GÃœNLÃœK RAPOR</button>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button class="secondary-btn" style="text-align:center; margin-top:0;" onclick="findBaitShops()">ğŸª± YEMCÄ° BUL</button>
                <button class="secondary-btn" style="text-align:center; margin-top:0;" onclick="saveFavorite()">â­ KAYDET</button>
            </div>

        </div>
    </div>
    
    <div id="weekly-modal" class="modal-overlay">
        <button class="secondary-btn" style="width:auto; margin-bottom:20px; background:rgba(255,255,255,0.05); text-align:center;" onclick="document.getElementById('weekly-modal').style.display='none'">â† GERÄ° DÃ–N</button>
        <h2 style="text-align:center; color:var(--blue); font-weight:900;">7 GÃœNLÃœK TAHMÄ°N</h2>
        <div style="text-align:center; color:#aaa; font-size:0.8em; margin-bottom:20px;">Detay gÃ¶rmek iÃ§in gÃ¼ne tÄ±klayÄ±n</div>
        <div id="weekly-content"></div>
    </div>

    <div id="day-detail-modal" class="modal-overlay">
        <button class="secondary-btn" style="width:auto; margin-bottom:20px; background:rgba(255,255,255,0.05); text-align:center;" onclick="document.getElementById('day-detail-modal').style.display='none'">â† LÄ°STEYE DÃ–N</button>
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:1.5em; font-weight:900;" id="dd-date">--</div>
            <div style="font-size:3em; font-weight:900; margin:10px 0;" id="dd-score">--</div>
            <div style="color:var(--blue); font-family:'Share Tech Mono'; font-weight:bold;" id="dd-weather">--</div>
        </div>
        <div style="background:rgba(59,130,246,0.1); border-left:3px solid var(--blue); padding:15px; border-radius:8px; font-size:0.9em; margin-bottom:20px;">
            <div style="font-weight:bold; color:var(--blue); margin-bottom:5px;">GÃœNLÃœK AKTÄ°VÄ°TELER:</div>
            <div id="dd-tactic">--</div>
        </div>
        <div id="dd-fish-list"></div>
    </div>

    <div id="tech-modal" class="modal-overlay">
        <button class="secondary-btn" style="width:auto; margin-bottom:20px; background:rgba(255,255,255,0.05); text-align:center;" onclick="document.getElementById('tech-modal').style.display='none'">KAPAT</button>
        <h2 style="text-align:center; color:var(--blue); font-weight:900; letter-spacing:1px; margin-bottom:30px;">F.I.S.H. ALGORÄ°TMASI</h2>
        <div class="tech-content">
            <div class="tech-item">
                <span class="tech-title">1. BULANIK MANTIK & VERÄ° FÃœZYONU (Fuzzy Logic)</span>
                Sistem, atmosferik verileri "Ä°yi/KÃ¶tÃ¼" gibi basit ikili sistemle deÄŸil, <strong>BulanÄ±k MantÄ±k</strong> ile iÅŸler. Ã–rneÄŸin; su sÄ±caklÄ±ÄŸÄ± 18Â°C olduÄŸunda Levrek iÃ§in %100, 24Â°C olduÄŸunda %40 verimlilik atayan <strong>Gaussian Ã‡an EÄŸrisi</strong> algoritmalarÄ± kullanÄ±lÄ±r. 12 farklÄ± deÄŸiÅŸken (IsÄ±, BasÄ±nÃ§, RÃ¼zgar vb.) tek bir potada eritilir.
            </div>
            <div class="tech-item">
                <span class="tech-title">2. BÄ°YORÄ°TÄ°M & SOLUNAR OLASILIÄI</span>
                BalÄ±klarÄ±n metabolik hÄ±zlarÄ± (Delta-T) ve beslenme dÃ¼rtÃ¼leri hesaplanÄ±r. Ay'Ä±n Ã§ekim gÃ¼cÃ¼ (Gravitational Pull) ve GÃ¼neÅŸ'in konumu (Civil Twilight) birleÅŸtirilerek, balÄ±ÄŸÄ±n avlanma ihtimali <strong>OlasÄ±lÄ±ksal (Probabilistic)</strong> olarak puanlanÄ±r.
            </div>
            <div class="tech-item">
                <span class="tech-title">3. KAOS TEORÄ°SÄ° & RÄ°SK ANALÄ°ZÄ°</span>
                DoÄŸa doÄŸrusal deÄŸildir. RÃ¼zgar yÃ¶nÃ¼ sapmalarÄ± (Lodos/Poyraz vektÃ¶rleri) ve ani basÄ±nÃ§ dÃ¼ÅŸÃ¼ÅŸlerini (Barometrik Åok) bir <strong>Kaos Ä°ndeksi</strong> olarak iÅŸler. Standart hava tahminlerinin Ã¶tesinde, doÄŸanÄ±n anlÄ±k belirsizliÄŸi hesaba katÄ±larak yapay bir "GÃ¼ven Skoru" Ã¼retilir.
            </div>
            <div class="tech-item">
                <span class="tech-title">4. JEOTERMAL & OÅÄ°NOGRAFÄ°K ADAPTASYON</span>
                Motor, GPS verisine gÃ¶re dinamik olarak mod deÄŸiÅŸtirir. Marmara Denizi iÃ§in <strong>Hidrodinamik AkÄ±ntÄ± Modeli</strong> (BoÄŸaz suyu) devreye girerken, Ege Denizi iÃ§in <strong>YÃ¼ksek Tuzluluk (38 PSU)</strong> katsayÄ±larÄ± ve kÄ±yÄ± topografyasÄ± analizi devreye girer.
            </div>
            <div style="text-align:center; font-size:0.8em; opacity:0.6; margin-top:20px;">
                Sources: E. Ä°ÅŸtipliler (2025), E. Ã‡iftÃ§i (2025), M. Peksu (2017)<br>System Code: FIND-INSPECT-SEE-HUNT
            </div>
        </div>
    </div>

    <div id="metric-modal" class="modal-overlay" style="justify-content:center; background:rgba(0,0,0,0.85);">
        <div style="background:var(--panel); border:1px solid var(--blue); padding:25px; border-radius:16px; width:90%; max-width:400px; text-align:center; position:relative;">
            <div id="metric-icon" style="font-size:3em; margin-bottom:10px;">ğŸŒ¡ï¸</div>
            <h3 id="metric-title" style="color:var(--blue); margin-top:0; margin-bottom:20px;">SU ISISI</h3>
            
            <div class="metric-info-row">
                <div class="metric-label">NEDÄ°R?</div>
                <div class="metric-val" id="metric-desc">...</div>
            </div>

            <div class="metric-info-row">
                <div class="metric-label">REFERANS ARALIÄI (Ä°DEAL)</div>
                <div class="metric-val" id="metric-ref">...</div>
            </div>

            <div class="metric-info-row">
                <div class="metric-label">ALGORÄ°TMA ETKÄ°SÄ°</div>
                <div class="metric-val" id="metric-algo" style="color:#a78bfa;">...</div>
            </div>

            <button class="action-btn" style="margin-top:10px; padding:12px;" onclick="document.getElementById('metric-modal').style.display='none'">KAPAT</button>
        </div>
    </div>

    <script>
        const METRIC_DATA = {
            "temp": { icon: "ğŸŒ¡ï¸", title: "SU ISISI", desc: "BalÄ±klar soÄŸukkanlÄ±dÄ±r, metabolizmalarÄ± ve yeme istekleri su sÄ±caklÄ±ÄŸÄ±na zincirlidir. Ani dÃ¼ÅŸÃ¼ÅŸler ÅŸok etkisi yaratÄ±r.", ref: "Ege: <span class='ref-green'>18-24Â°C</span> | Marmara: <span class='ref-green'>14-19Â°C</span>", algo: "Backend, 'Gaussian Ã‡an EÄŸrisi' ile sÄ±caklÄ±k sapmalarÄ±nÄ± hesaplar. Delta-T (Hava-Su farkÄ±) > 5Â°C ise puan dÃ¼ÅŸer." },
            "clarity": { icon: "ğŸ‘ï¸", title: "SU GÃ–RÃœÅÃœ", desc: "AvcÄ± balÄ±klarÄ±n (Levrek, LÃ¼fer) yemi gÃ¶rme mesafesidir. Berrak suda balÄ±k misinayÄ± gÃ¶rÃ¼r.", ref: "Ä°deal: <span class='ref-green'>%50 - %85</span> (Ne Ã§ok bulanÄ±k ne Ã§ok berrak)", algo: "BerraklÄ±k > %90 ise 'GÃ¶rÃ¼nmez TakÄ±m' uyarÄ±sÄ± tetiklenir. BulanÄ±klÄ±k < %40 ise 'Koku/Ses' bonusu devreye girer." },
            "wind": { icon: "ğŸ’¨", title: "RÃœZGAR YÃ–NÃœ/HIZI", desc: "RÃ¼zgar planktonu kÄ±yÄ±ya taÅŸÄ±r. YÃ¶nÃ¼ (Lodos/Poyraz) suyun Ä±sÄ±sÄ±nÄ± ve berraklÄ±ÄŸÄ±nÄ± deÄŸiÅŸtirir.", ref: "GÃ¼venli: <span class='ref-green'>0-25 km/s</span> | Riskli: <span class='ref-red'>40+ km/s</span>", algo: "Lodos (GÃ¼ney) rÃ¼zgarÄ± Marmara'da +15 Puan bonus verir. 35km Ã¼zeri hÄ±z 'GÃ¼venlik Kesintisi' uygular." },
            "wave": { icon: "ğŸŒŠ", title: "DALGA BOYU", desc: "KÃ¶pÃ¼klÃ¼ su oksijen ve kamuflaj saÄŸlar. Levrek gibi avcÄ±lar dalgalÄ± suyu sever.", ref: "AvcÄ± Ä°Ã§in: <span class='ref-green'>0.5m - 1.2m</span> | LRF Ä°Ã§in: <span class='ref-green'>0.1m - 0.4m</span>", algo: "Dalga > 0.6m olduÄŸunda Levrek ve Sargoz iÃ§in 'Pusu Bonusu' (+20 Puan) eklenir." },
            "salinity": { icon: "ğŸ§‚", title: "TUZLULUK & OZMOTÄ°K DENGE", desc: "Tuzluluk, balÄ±ÄŸÄ±n kaldÄ±rma kuvvetini ve enerji tÃ¼ketimini (Ozmotik BasÄ±nÃ§) etkiler. TatlÄ± suyun denize karÄ±ÅŸtÄ±ÄŸÄ± (TuzluluÄŸun dÃ¼ÅŸtÃ¼ÄŸÃ¼) nehir aÄŸÄ±zlarÄ±, avcÄ± balÄ±klarÄ±n en sevdiÄŸi pusu alanlarÄ±dÄ±r.", ref: "Ege: <span class='ref-green'>~38 PSU (YÃ¼ksek)</span> | Marmara: <span class='ref-green'>~22 PSU (DÃ¼ÅŸÃ¼k)</span>", algo: "BÃ¶lge tespitinde kullanÄ±lÄ±r. AyrÄ±ca sistem yaÄŸmur verisine bakarak 'Nehir AÄŸzÄ±' simÃ¼lasyonu yapar; yaÄŸmur sonrasÄ± tuzluluk dÃ¼ÅŸeceÄŸi iÃ§in Levrek puanÄ±na 'Brackish Water' (AcÄ± Su) bonusu ekler." },
            "pressure": { icon: "ğŸ“‰", title: "HAVA BASINCI", desc: "Denizlerin 'FÄ±rtÄ±na AlarmÄ±'dÄ±r. BasÄ±nÃ§ dÃ¼ÅŸerken balÄ±ÄŸÄ±n hava kesesi ÅŸiÅŸer, aÃ§gÃ¶zlÃ¼ olur (Gorging).", ref: "SÃ¼per Av: <span class='ref-green'>1008 - 1012 hPa (DÃ¼ÅŸen)</span> | KÃ¶tÃ¼: <span class='ref-red'>1020+ hPa (YÃ¼ksek)</span>", algo: "BasÄ±nÃ§ dÃ¼ÅŸÃ¼ÅŸ trendindeyse (DÃ¼n > BugÃ¼n) sistem 'Feeding Frenzy' (Beslenme Ã‡Ä±lgÄ±nlÄ±ÄŸÄ±) modunu aÃ§ar ve skoru 1.2x (Ã‡arpan) ile artÄ±rÄ±r." },
            "moon": { icon: "ğŸŒ‘", title: "AY FAZI & SOLUNAR", desc: "Ay sadece fener deÄŸil, okyanusun motorudur. Dolunay ve Yeni Ay'da yerÃ§ekimi artar (Spring Tides).", ref: "Dolunay: <span class='ref-green'>Koyu Renk (Siyah/Mor)</span> | Yeni Ay: <span class='ref-green'>Glow (Fosfor)</span>", algo: "Dolunayda (IÅŸÄ±k %80+) sistem 'SilÃ¼et Bonusu' verir. Yeni Ayda 'Duyu Bonusu' devreye girer." },
            "tide": { icon: "ğŸŒŠ", title: "GELGÄ°T (MEDCEZÄ°R)", desc: "Denizdeki 'Yemek Zili'dir. Su hareketliyse av vardÄ±r. Su durursa (Slack Tide) av biter.", ref: "Ä°deal: <span class='ref-green'>Su Hareketli</span> | KÃ¶tÃ¼: <span class='ref-red'>Su DurmasÄ± (Slack)</span>", algo: "Gelgit deÄŸiÅŸim hÄ±zÄ± > 0.3 m/s ise 'Aktif Av' bonusu eklenir." },
            "current": { icon: "ğŸ”„", title: "AKINTI HIZI", desc: "BoÄŸaz'Ä±n can damarÄ±dÄ±r. Suyu oksijenlendirir ve besin taÅŸÄ±r. AvcÄ± balÄ±klar akÄ±ntÄ±nÄ±n kÄ±yÄ±sÄ±nda (Ayna) bekler.", ref: "LRF: <span class='ref-green'>< 0.4 m/s</span> | KurÅŸun ArkasÄ±: <span class='ref-green'>0.6+ m/s</span>", algo: "AkÄ±ntÄ± > 0.7 m/s ise Pelajik (GÃ¶Ã§) balÄ±klarÄ±nÄ±n puanÄ± %30 artar." },
            "cloud": { icon: "â˜ï¸", title: "BULUTLULUK", desc: "IÅŸÄ±ÄŸÄ± yayar (DifÃ¼zyon). BalÄ±k gÃ¼neÅŸten kÃ¶r olmaz, daha cesur gezer.", ref: "AvcÄ± Ä°Ã§in: <span class='ref-green'>%60 - %100 (KapalÄ±)</span>", algo: "Bulut > %70 ise 'YÃ¼zey Sahtesi' (Topwater) bonusu eklenir." }
        };

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([38.4237, 27.1428], 10);
        const layers = { 
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 }), 
            street: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }) 
        };
        let currentLayer = 'street'; layers.street.addTo(map); 
        let markerLayer = null; let weeklyDataCache = null; let lastLatLon = null;
        let baitMarkers = [];

        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splash-screen').style.opacity = '0';
                document.getElementById('controls-bar').classList.add('visible'); setTimeout(() => { document.getElementById('splash-screen').style.display = 'none'; }, 800);
            }, 3000); 
            loadFavorites();
        });

        function getColor(s) { return s >= 80 ? 'var(--green)' : (s >= 50 ? 'var(--yellow)' : 'var(--red)'); }

        function analyzeMetric(key, val) {
            let status = 'neutral';
            let label = '';
            if (key === 'temp') {
                if (val >= 16 && val <= 24) { status = 'good'; label = 'Ä°deal'; } else if (val < 12) { status = 'bad'; label = 'SoÄŸuk'; } else if (val > 26) { status = 'warn'; label = 'SÄ±cak'; } else { status = 'neutral'; label = 'Normal'; }
            } else if (key === 'wind') {
                if (val <= 15) { status = 'good'; label = 'Sakin'; } else if (val <= 30) { status = 'warn'; label = 'Sert'; } else { status = 'bad'; label = 'FÄ±rtÄ±na'; }
            } else if (key === 'wave') {
                if (val >= 0.3 && val <= 1.0) { status = 'good'; label = 'Ä°deal'; } else if (val < 0.3) { status = 'warn'; label = 'Durgun'; } else { status = 'bad'; label = 'Tehlikeli'; }
            } else if (key === 'clarity') {
                if (val > 85) { status = 'warn'; label = 'Ã‡ok Net'; } else if (val >= 50) { status = 'good'; label = 'Net'; } else if (val >= 30) { status = 'warn'; label = 'Puslu'; } else { status = 'bad'; label = 'Ã‡amur'; }
            } else if (key === 'pressure') {
                if (val >= 1010 && val <= 1018) { status = 'good'; label = 'Stabil'; } else if (val < 1008) { status = 'warn'; label = 'DÃ¼ÅŸÃ¼k'; } else { status = 'neutral'; label = 'YÃ¼ksek'; }
            }
            return { status: `status-${status}`, label: label, val: val };
        }

        function createMetricCard(key, rawVal, unit) {
            if (rawVal === undefined || rawVal === null) rawVal = '--';
            const analysis = analyzeMetric(key, rawVal);
            const displayVal = rawVal + unit;
            const labelHtml = analysis.label ? `<div class="m-status ${analysis.status}">${analysis.label}</div>` : '';
            let valColor = 'white';
            if (key === 'moon') valColor = 'var(--yellow)';
            if (key === 'salinity') valColor = 'var(--blue)';
            return `<div class="metric-card" onclick="openMetricInfo('${key}')"><div class="m-val" style="color:${valColor}">${displayVal}</div>${labelHtml}<div class="m-lbl">${METRIC_DATA[key].title}</div></div>`;
        }

        map.on('click', async (e) => {
            const lat = e.latlng.lat.toFixed(4); const lon = e.latlng.lng.toFixed(4); lastLatLon = { lat, lon };
            if(markerLayer) map.removeLayer(markerLayer);
            baitMarkers.forEach(m => map.removeLayer(m)); baitMarkers = [];

            markerLayer = L.marker([lat, lon], { icon: L.divIcon({ className: 'radar-pin', iconSize: [24, 24], iconAnchor: [12, 12] }) }).addTo(map);
            
            document.getElementById('hud-panel').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            
            try {
                const res = await fetch(`/api/forecast?lat=${lat}&lon=${lon}`); const data = await res.json();
                document.getElementById('loading').style.display = 'none';
                if(data.isLand) { alert("BurasÄ± kara parÃ§asÄ±!"); return; }
                weeklyDataCache = data.forecast; 
                showResults(data, data.forecast[0]);
            } catch(err) { 
                document.getElementById('loading').style.display = 'none';
                alert("BaÄŸlantÄ± hatasÄ±."); 
            }
        });

        async function findBaitShops() {
            if (!lastLatLon) { alert("Ã–nce haritadan bir nokta seÃ§in!"); return; }
            alert("YakÄ±ndaki av bayileri taranÄ±yor (50km)...");
            
            try {
                const res = await fetch(`/api/places?lat=${lastLatLon.lat}&lon=${lastLatLon.lon}`);
                const places = await res.json();
                
                if (places.length === 0) { alert("Bu bÃ¶lgede haritada kayÄ±tlÄ± yemci bulunamadÄ±."); return; }
                
                places.forEach(p => {
                    const marker = L.marker([p.lat, p.lon], { 
                        icon: L.divIcon({ 
                            html: 'ğŸª±', 
                            className: 'bait-icon', 
                            iconSize: [24, 24], 
                            iconAnchor: [12, 24] 
                        }) 
                    }).addTo(map);
                    marker.bindPopup(`<b>${p.name}</b><br>ğŸ“ ${p.phone}`);
                    baitMarkers.push(marker);
                });
                
                document.getElementById('hud-panel').style.display = 'none';
                alert(`${places.length} adet yemci bulundu! Turuncu ikonlara tÄ±klayÄ±n.`);
                
            } catch (err) {
                alert("Arama baÅŸarÄ±sÄ±z.");
            }
        }

        function showResults(data, today) {
            document.getElementById('hud-panel').style.display = 'flex';
            document.querySelector('.panel-content').scrollTop = 0; 
            
            document.getElementById('region-title').innerText = data.region;
            document.getElementById('score-val').innerHTML = '<span style="font-size:0.4em; vertical-align:super; opacity:0.8;">%</span>' + today.score.toFixed(1);
            document.getElementById('score-val').style.color = getColor(today.score);
            document.getElementById('conf-val').innerText = "GÃœVEN: %" + today.confidence;
            document.getElementById('weather-val').innerText = today.weatherSummary || "";
            document.getElementById('tactic-text').innerText = today.tactic;

            const grid = document.getElementById('main-grid');
            grid.innerHTML = 
                createMetricCard('temp', today.temp, 'Â°') +
                createMetricCard('clarity', today.clarity, '%') +
                createMetricCard('wind', today.wind, ' km') +
                createMetricCard('wave', today.wave, 'm') +
                createMetricCard('salinity', today.salinity, ' PSU') +
                createMetricCard('pressure', today.pressure, ' hPa') +
                `<div class="metric-card" onclick="openMetricInfo('moon')"><div class="m-val" style="color:var(--yellow)">${getMoonName(today.moonPhase)}</div><div class="m-lbl">AY FAZI</div></div>` + 
                createMetricCard('tide', today.tide, 'm') +
                createMetricCard('current', today.current, '') +
                createMetricCard('cloud', today.cloud, '%');

            renderFishList(today.fishList, 'fish-list');
        }

        function renderFishList(list, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            list.forEach(f => {
                const c = getColor(f.score);
                const jig = f.jig || '--';
                const depth = f.depth || '--';
                const reason = f.reason ? `<div style="font-size:0.8em; color:${f.score > 50 ? 'var(--green)' : 'var(--red)'}; margin-bottom:5px; font-weight:bold;">${f.score > 50 ? 'âœ…' : 'âš ï¸'} ${f.reason}</div>` : '';
                
                container.innerHTML += `
                    <div class="fish-item" style="border-left-color:${c}" onclick="this.classList.toggle('open')">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:bold;">${f.icon} ${f.name}</div>
                            <div style="font-weight:900; color:${c}">%${f.score.toFixed(1)}</div>
                        </div>
                        <div class="fish-details">
                            ${reason}
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                                <div style="background:rgba(255,255,255,0.05); padding:5px; border-radius:4px;">
                                    <div style="font-size:0.7em; color:var(--gray);">Ä°DEAL JIG</div>
                                    <div style="font-weight:bold; font-size:0.85em;">${jig}</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.05); padding:5px; border-radius:4px;">
                                    <div style="font-size:0.7em; color:var(--gray);">DERÄ°NLÄ°K</div>
                                    <div style="font-weight:bold; font-size:0.85em;">${depth}</div>
                                </div>
                            </div>
                            <div>ğŸ¯ <b>Yem:</b> ${f.bait}</div>
                            <div>ğŸ£ <b>Ä°ÄŸne:</b> ${f.method}</div>
                            <div style="margin-top:5px; color:#e2e8f0; font-style:italic; font-size:0.9em;">ğŸ’¡ ${f.note}</div>
                        </div>
                    </div>`;
            });
        }
        
        function openMetricInfo(key) {
            const data = METRIC_DATA[key];
            if(!data) return;
            document.getElementById('metric-icon').innerText = data.icon;
            document.getElementById('metric-title').innerText = data.title;
            document.getElementById('metric-desc').innerText = data.desc;
            document.getElementById('metric-ref').innerHTML = data.ref;
            document.getElementById('metric-algo').innerText = data.algo;
            document.getElementById('metric-modal').style.display = 'flex';
        }

        function getMoonName(phase) {
            if(phase < 0.05 || phase > 0.95) return "Yeni Ay";
            if(phase < 0.25) return "Hilal";
            if(phase < 0.45) return "Ä°lk DÃ¶rdÃ¼n";
            if(phase < 0.55) return "Dolunay";
            if(phase < 0.75) return "Son DÃ¶rdÃ¼n";
            return "Hilal";
        }

        function showWeeklyModal() {
            const m = document.getElementById('weekly-modal');
            const c = document.getElementById('weekly-content');
            c.innerHTML = '';
            weeklyDataCache.forEach((d, i) => {
                const date = new Date(d.date).toLocaleDateString('tr-TR', {weekday:'long', day:'numeric', month:'short'});
                c.innerHTML += `
                    <div class="day-row" onclick="openDayDetail(${i})">
                        <div>
                            <div style="font-weight:800; color:white; font-size:1.1em;">${date}</div>
                            <div style="color:#aaa; font-size:0.85em; margin-top:4px;">${d.weatherSummary || ''}</div>
                        </div>
                        <div class="day-score-badge" style="color:${getColor(d.score)}; border:2px solid ${getColor(d.score)};">%${d.score.toFixed(1)}</div>
                    </div>`;
            });
            m.style.display = 'flex';
        }

        function openDayDetail(index) {
            const d = weeklyDataCache[index];
            const dateStr = new Date(d.date).toLocaleDateString('tr-TR', {weekday:'long', day:'numeric'});
            document.getElementById('dd-date').innerText = dateStr;
            document.getElementById('dd-score').innerText = "%" + d.score.toFixed(1);
            document.getElementById('dd-score').style.color = getColor(d.score);
            document.getElementById('dd-weather').innerText = d.weatherSummary || '--';
            document.getElementById('dd-tactic').innerText = d.tactic;
            renderFishList(d.fishList, 'dd-fish-list');
            document.getElementById('day-detail-modal').style.display = 'flex';
        }

        function closePanel() { document.getElementById('hud-panel').style.display = 'none'; if(markerLayer) map.removeLayer(markerLayer); }
        function toggleMenu() { document.getElementById('side-menu').classList.toggle('active'); document.getElementById('menu-overlay').style.display = document.getElementById('side-menu').classList.contains('active') ? 'block' : 'none'; }
        function changeMapLayer() { if(currentLayer === 'satellite') { map.removeLayer(layers.satellite); layers.street.addTo(map); currentLayer = 'street'; } else { map.removeLayer(layers.street); layers.satellite.addTo(map); currentLayer = 'satellite'; } toggleMenu(); }
        function openTechModal() { toggleMenu(); document.getElementById('tech-modal').style.display = 'flex'; }
        function saveFavorite() { if(!lastLatLon) return; const name = prompt("Mera AdÄ±:"); if(!name) return; let f = JSON.parse(localStorage.getItem('fish_favs') || '[]'); f.push({ name, ...lastLatLon }); localStorage.setItem('fish_favs', JSON.stringify(f)); loadFavorites(); alert("Kaydedildi!"); }
        function loadFavorites() { const l = document.getElementById('fav-list'); const f = JSON.parse(localStorage.getItem('fish_favs') || '[]'); l.innerHTML = ''; if(f.length===0) l.innerHTML='<div style="color:#666; font-size:0.9em;">HenÃ¼z kayÄ±t yok.</div>'; f.forEach((fav, i) => l.innerHTML += `<div style="padding:10px; border-bottom:1px solid #333;" onclick="map.flyTo([${fav.lat},${fav.lon}],14); toggleMenu(); map.fire('click',{latlng:{lat:${fav.lat},lon:${fav.lon}}})">ğŸ“ ${fav.name}</div>`); }
        
        let debounceTimer; document.getElementById('search-input').addEventListener('input', (e) => { clearTimeout(debounceTimer); if(e.target.value.length < 3) { document.getElementById('suggestions').style.display='none'; return; } debounceTimer = setTimeout(async () => { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e.target.value)}`); const d = await res.json(); const b = document.getElementById('suggestions'); b.innerHTML=''; if(d.length>0) { b.style.display='flex'; d.slice(0,5).forEach(i => { const div=document.createElement('div'); div.className='suggestion-item'; div.innerText=i.display_name.split(',')[0]; div.onclick=()=>{ map.flyTo([i.lat,i.lon],13); b.style.display='none'; }; b.appendChild(div); }); } }, 500); });
        function locateMe() { navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 14)); }
    </script>
</body>
</html>
